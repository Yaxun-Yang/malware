import pandas as pd
import numpy as np
import math


def read_data():
    data = pd.read_csv("base_data/dwd_yunsec_aegis_file_vis_netstate_info.csv", sep="|", header=None)
    data1 = pd.read_csv("base_data/dwd_yunsec_aegis_file_vis_base_info.csv", usecols=[0])
    data = data.to_numpy()
    data1 = data1.to_numpy()

    return data, data1


def get_esc_type(data):
    son_num_of_vpc = {}
    son_num_of_az = {}
    fa_of_az = {}
    fa_of_esc = {}
    type_of_esc = {}
    for i in range(len(data)):
        if isinstance(data[i][1], float) and math.isnan(data[i][1]):
            fa_of_esc[data[i][0]] = 0
        else:
            fa_of_esc[data[i][0]] = data[i][1]
            fa_of_az[data[i][1]] = data[i][2]
            if data[i][1] in son_num_of_az:
                son_num_of_az[data[i][1]] += 1
            else:
                son_num_of_az[data[i][1]] = 1

            if data[i][2] in son_num_of_vpc:
                son_num_of_vpc[data[i][2]] += 1
            else:
                son_num_of_vpc[data[i][2]] = 1

    for key in fa_of_esc:
        if fa_of_esc[key] == 0:
            type_of_esc[key] = 3
        elif son_num_of_az[fa_of_esc[key]] > 1:
            type_of_esc[key] = 2
        elif son_num_of_vpc[fa_of_az[fa_of_esc[key]]] > 1:
            type_of_esc[key] = 1
        else:
            type_of_esc[key] = 0

    return type_of_esc


def main():
    data, data1 = read_data()
    type_of_esc = get_esc_type(data)
    new_data = np.empty([len(data1), 4])
    for i in range(len(data1)):
        if type_of_esc[data1[i][0]] == 0:
            new_data[i] = [0, 0, 0, 1]
        elif type_of_esc[data1[i][0]] == 1:
            new_data[i] = [0, 0, 1, 0]
        elif type_of_esc[data1[i][0]] == 2:
            new_data[i] = [0, 1, 0, 0]
        else:
            new_data[i] = [1, 0, 0, 0]

    new_data = new_data.transpose()
    df = pd.DataFrame({"Only-ECS": new_data[0], "Multi-AZ": new_data[1],
                       "Flower": new_data[2], "Chain": new_data[3]})
    df.to_csv("processed_data/netstate_feature.csv", mode='w', sep=',', index=False)


if __name__ == '__main__':
    main()
